# 视频录制模块说明

## 📦 模块概览

视频录制功能已完全模块化，新增 `video-recorder.js` 模块，与其他模块解耦，提供独立的录制和导出API。

### 核心文件

```
video-recorder.js    # 视频录制模块（新增）
main.js             # 集成VideoRecorder（已更新）
upload.js           # 添加回调机制（已更新）
index.html          # 添加录制按钮（已更新）
styles.css          # 录制按钮样式（已更新）
API.md              # API文档（已更新）
```

---

## 🎯 核心接口

### 1. 创建录制器

```javascript
import { VideoRecorder } from './video-recorder.js';

const videoRecorder = new VideoRecorder(sceneManager, modelManager, controlsManager);
```

### 2. 初始化元素

```javascript
videoRecorder.initElements({
    recordButton: document.getElementById('recordButton')
});
```

### 3. 录制视频

```javascript
// 默认参数：5秒，60 FPS，旋转1圈
await videoRecorder.recordVideo();

// 自定义参数
await videoRecorder.recordVideo({
    duration: 10000,   // 10秒
    fps: 30,           // 30帧
    bitrate: 3000000,  // 3 Mbps
    rotations: 2       // 旋转2圈
});
```

### 4. 控制录制按钮

```javascript
// 启用录制按钮（创建卡片后）
videoRecorder.enableRecordButton();

// 禁用录制按钮
videoRecorder.disableRecordButton();
```

### 5. 检查支持性

```javascript
// 检查浏览器是否支持
if (videoRecorder.isSupported()) {
    console.log('支持视频录制');
}

// 获取支持的MIME类型
const mimeType = videoRecorder.getSupportedMimeType();
console.log(mimeType); // "video/webm;codecs=vp9"
```

---

## 🔧 集成方式

### 在 main.js 中集成

```javascript
import { VideoRecorder } from './video-recorder.js';

class App {
    constructor() {
        // ...其他管理器
        this.videoRecorder = null;
    }
    
    init() {
        // 初始化录制器
        this.videoRecorder = new VideoRecorder(
            this.sceneManager, 
            this.modelManager, 
            this.controlsManager
        );
        
        // 初始化按钮
        this.videoRecorder.initElements({
            recordButton: document.getElementById('recordButton')
        });
        
        // 设置卡片创建后的回调
        this.uploadManager.setOnCardCreatedCallback(() => {
            this.videoRecorder.enableRecordButton();
        });
    }
    
    getVideoRecorder() {
        return this.videoRecorder;
    }
}
```

### 在 upload.js 中集成

```javascript
export class UploadManager {
    constructor(modelManager) {
        this.modelManager = modelManager;
        this.onCardCreatedCallback = null;
    }
    
    async createCard(options) {
        // 创建卡片逻辑...
        await this.modelManager.createTexturedCard(...);
        
        // 触发回调（启用录制按钮）
        if (this.onCardCreatedCallback) {
            this.onCardCreatedCallback();
        }
    }
    
    setOnCardCreatedCallback(callback) {
        this.onCardCreatedCallback = callback;
    }
}
```

---

## 📋 完整使用示例

### 示例1: 基础使用

```javascript
import app from './main.js';

// 获取录制器
const videoRecorder = app.getVideoRecorder();

// 创建卡片（会自动启用录制按钮）
await app.getUploadManager().createCard({
    frontImageData: frontImageURL,
    backImageData: backImageURL
});

// 手动录制
await videoRecorder.recordVideo();
```

### 示例2: 自动化流程

```javascript
import app from './main.js';

async function autoCreateAndRecord(frontData, backData) {
    // 1. 创建卡片
    await app.getUploadManager().createCard({
        frontImageData: frontData,
        backImageData: backData
    });
    
    // 2. 等待渲染稳定
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // 3. 自动录制视频
    await app.getVideoRecorder().recordVideo({
        duration: 5000,
        fps: 60,
        bitrate: 5000000,
        rotations: 1
    });
    
    console.log('视频已保存');
}
```

### 示例3: 批量录制

```javascript
import app from './main.js';

async function batchRecording(cardDataArray) {
    for (const { front, back, name } of cardDataArray) {
        // 创建卡片
        await app.getUploadManager().createCard({
            frontImageData: front,
            backImageData: back
        });
        
        // 录制视频
        await app.getVideoRecorder().recordVideo();
        
        console.log(`${name} 录制完成`);
        
        // 等待一下，避免过快
        await new Promise(resolve => setTimeout(resolve, 1000));
    }
}
```

### 示例4: 高级配置

```javascript
import app from './main.js';

async function recordWithPreset(preset) {
    const presets = {
        high: {
            duration: 8000,
            fps: 60,
            bitrate: 10000000,
            rotations: 1
        },
        medium: {
            duration: 5000,
            fps: 30,
            bitrate: 5000000,
            rotations: 1
        },
        low: {
            duration: 3000,
            fps: 24,
            bitrate: 2000000,
            rotations: 0.5
        }
    };
    
    await app.getVideoRecorder().recordVideo(presets[preset]);
}

// 使用
await recordWithPreset('high');
```

---

## 🎨 自定义样式

### 录制按钮样式

在 `styles.css` 中定义：

```css
.record-btn {
    background: #f44336;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
}

.record-btn:hover:not(:disabled) {
    background: #d32f2f;
    transform: translateY(-2px);
}

.record-btn:disabled {
    background: rgba(244, 67, 54, 0.3);
    cursor: not-allowed;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}
```

### 录制中状态

录制时按钮自动显示脉动动画：

```javascript
// 在 video-recorder.js 内部自动处理
_updateButtonState(recording) {
    if (recording) {
        this.recordButton.style.animation = 'pulse 1.5s ease-in-out infinite';
        this.recordButton.textContent = '⏺️ 录制中...';
    } else {
        this.recordButton.style.animation = 'none';
        this.recordButton.textContent = '🎬 生成视频';
    }
}
```

---

## 📊 参数说明

### recordVideo(options)

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `duration` | number | 5000 | 录制时长（毫秒） |
| `fps` | number | 60 | 视频帧率 |
| `bitrate` | number | 5000000 | 视频码率（bps） |
| `rotations` | number | 1 | 旋转圈数 |

### 推荐配置

#### 高质量（适合展示）
```javascript
{
    duration: 8000,
    fps: 60,
    bitrate: 10000000,
    rotations: 1
}
```

#### 标准质量（推荐）
```javascript
{
    duration: 5000,
    fps: 60,
    bitrate: 5000000,
    rotations: 1
}
```

#### 低质量（快速预览）
```javascript
{
    duration: 3000,
    fps: 30,
    bitrate: 2000000,
    rotations: 0.5
}
```

---

## 🔍 技术细节

### 录制流程

```
1. 检查浏览器支持
   ↓
2. 获取Canvas视频流 (captureStream)
   ↓
3. 创建MediaRecorder
   ↓
4. 保存当前旋转状态
   ↓
5. 执行旋转动画（EaseInOut）
   ↓
6. 收集视频数据块
   ↓
7. 停止录制
   ↓
8. 生成Blob并下载
   ↓
9. 恢复原始状态
```

### 缓动函数

使用 **EaseInOut** 使旋转更加平滑：

```javascript
const easeProgress = progress < 0.5 
    ? 2 * progress * progress                    // 前半段：加速
    : 1 - Math.pow(-2 * progress + 2, 2) / 2;   // 后半段：减速
```

### 编码支持

自动检测并选择最佳编码：

```javascript
getSupportedMimeType() {
    const types = [
        'video/webm;codecs=vp9',   // 优先
        'video/webm;codecs=vp8',   // 备选
        'video/webm'               // 降级
    ];
    
    for (const type of types) {
        if (MediaRecorder.isTypeSupported(type)) {
            return type;
        }
    }
    
    return 'video/webm';
}
```

---

## 🧪 测试

### 运行测试套件

打开 `tests/test-video-recording.html` 进行测试：

```
http://localhost:8000/tests/test-video-recording.html
```

### 测试项目

1. ✅ 浏览器支持检查
2. ✅ 创建卡片并启用录制
3. ✅ 默认参数录制
4. ✅ 自定义参数录制
5. ✅ 编程方式录制

### 手动测试

```javascript
// 在浏览器控制台
const recorder = app.getVideoRecorder();

// 测试支持性
console.log('支持:', recorder.isSupported());
console.log('MIME:', recorder.getSupportedMimeType());

// 测试录制
await recorder.recordVideo({
    duration: 3000,
    fps: 30,
    rotations: 1
});
```

---

## ⚠️ 注意事项

### 浏览器兼容性

| 浏览器 | 支持 | VP9 | VP8 | 推荐 |
|--------|------|-----|-----|------|
| Chrome 47+ | ✅ | ✅ | ✅ | ⭐⭐⭐⭐⭐ |
| Firefox 25+ | ✅ | ✅ | ✅ | ⭐⭐⭐⭐⭐ |
| Edge 79+ | ✅ | ✅ | ✅ | ⭐⭐⭐⭐⭐ |
| Safari 14.1+ | ⚠️ | ❌ | ⚠️ | ⭐⭐⭐ |

### 最佳实践

1. **录制前检查卡片是否存在**
```javascript
const cube = app.getModelManager().getCube();
if (!cube) {
    alert('请先创建3D卡片');
    return;
}
```

2. **避免重复录制**
```javascript
if (recorder.getRecordingState()) {
    console.log('正在录制中，请等待');
    return;
}
```

3. **错误处理**
```javascript
try {
    await recorder.recordVideo();
} catch (error) {
    console.error('录制失败:', error);
    alert('录制失败，请重试');
}
```

4. **性能优化**
```javascript
// 录制前暂停不必要的动画
app.getControlsManager().setAutoRotate(false);

// 录制完成后恢复
// （VideoRecorder会自动处理）
```

---

## 🚀 扩展功能

### 添加进度回调

可以扩展 `VideoRecorder` 添加进度回调：

```javascript
async recordVideo(options = {}, onProgress) {
    // ...
    const animate = () => {
        const progress = Math.min(elapsed / duration, 1);
        
        // 调用进度回调
        if (onProgress) {
            onProgress(progress);
        }
        
        // ...
    };
}

// 使用
await recorder.recordVideo({}, (progress) => {
    console.log(`录制进度: ${(progress * 100).toFixed(0)}%`);
});
```

### 添加暂停/恢复功能

```javascript
pauseRecording() {
    if (this.mediaRecorder && this.isRecording) {
        this.mediaRecorder.pause();
    }
}

resumeRecording() {
    if (this.mediaRecorder && this.isRecording) {
        this.mediaRecorder.resume();
    }
}
```

### 添加多角度录制

```javascript
async recordMultiAngle() {
    const angles = [
        { x: 0, y: 0 },       // 正面
        { x: 0.3, y: 0 },     // 俯视
        { x: -0.3, y: 0 },    // 仰视
        { x: 0, y: Math.PI/2 } // 侧面
    ];
    
    for (const angle of angles) {
        cube.rotation.x = angle.x;
        cube.rotation.y = angle.y;
        await this.recordVideo({ duration: 3000 });
    }
}
```

---

## 📖 API文档

完整的API文档请查看：[API.md](./API.md#视频录制器-videorecorder)

---

## 🎉 总结

视频录制模块现已完全模块化，提供：

✅ **独立模块** - `video-recorder.js` 独立可复用  
✅ **清晰API** - 简单直观的接口设计  
✅ **自动集成** - 与现有模块无缝集成  
✅ **完善文档** - 详细的使用说明和示例  
✅ **测试覆盖** - 完整的测试套件  
✅ **高可扩展** - 易于添加新功能  

现在你可以通过简单的API调用实现专业的3D卡片视频录制功能！🎬

---

**最后更新**: 2025-10-27  
**版本**: 1.0.0

