# è§†é¢‘å½•åˆ¶æ¨¡å—è¯´æ˜

## ğŸ“¦ æ¨¡å—æ¦‚è§ˆ

è§†é¢‘å½•åˆ¶åŠŸèƒ½å·²å®Œå…¨æ¨¡å—åŒ–ï¼Œæ–°å¢ `video-recorder.js` æ¨¡å—ï¼Œä¸å…¶ä»–æ¨¡å—è§£è€¦ï¼Œæä¾›ç‹¬ç«‹çš„å½•åˆ¶å’Œå¯¼å‡ºAPIã€‚

### æ ¸å¿ƒæ–‡ä»¶

```
video-recorder.js    # è§†é¢‘å½•åˆ¶æ¨¡å—ï¼ˆæ–°å¢ï¼‰
main.js             # é›†æˆVideoRecorderï¼ˆå·²æ›´æ–°ï¼‰
upload.js           # æ·»åŠ å›è°ƒæœºåˆ¶ï¼ˆå·²æ›´æ–°ï¼‰
index.html          # æ·»åŠ å½•åˆ¶æŒ‰é’®ï¼ˆå·²æ›´æ–°ï¼‰
styles.css          # å½•åˆ¶æŒ‰é’®æ ·å¼ï¼ˆå·²æ›´æ–°ï¼‰
API.md              # APIæ–‡æ¡£ï¼ˆå·²æ›´æ–°ï¼‰
```

---

## ğŸ¯ æ ¸å¿ƒæ¥å£

### 1. åˆ›å»ºå½•åˆ¶å™¨

```javascript
import { VideoRecorder } from './video-recorder.js';

const videoRecorder = new VideoRecorder(sceneManager, modelManager, controlsManager);
```

### 2. åˆå§‹åŒ–å…ƒç´ 

```javascript
videoRecorder.initElements({
    recordButton: document.getElementById('recordButton')
});
```

### 3. å½•åˆ¶è§†é¢‘

```javascript
// é»˜è®¤å‚æ•°ï¼š5ç§’ï¼Œ60 FPSï¼Œæ—‹è½¬1åœˆ
await videoRecorder.recordVideo();

// è‡ªå®šä¹‰å‚æ•°
await videoRecorder.recordVideo({
    duration: 10000,   // 10ç§’
    fps: 30,           // 30å¸§
    bitrate: 3000000,  // 3 Mbps
    rotations: 2       // æ—‹è½¬2åœˆ
});
```

### 4. æ§åˆ¶å½•åˆ¶æŒ‰é’®

```javascript
// å¯ç”¨å½•åˆ¶æŒ‰é’®ï¼ˆåˆ›å»ºå¡ç‰‡åï¼‰
videoRecorder.enableRecordButton();

// ç¦ç”¨å½•åˆ¶æŒ‰é’®
videoRecorder.disableRecordButton();
```

### 5. æ£€æŸ¥æ”¯æŒæ€§

```javascript
// æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ
if (videoRecorder.isSupported()) {
    console.log('æ”¯æŒè§†é¢‘å½•åˆ¶');
}

// è·å–æ”¯æŒçš„MIMEç±»å‹
const mimeType = videoRecorder.getSupportedMimeType();
console.log(mimeType); // "video/webm;codecs=vp9"
```

---

## ğŸ”§ é›†æˆæ–¹å¼

### åœ¨ main.js ä¸­é›†æˆ

```javascript
import { VideoRecorder } from './video-recorder.js';

class App {
    constructor() {
        // ...å…¶ä»–ç®¡ç†å™¨
        this.videoRecorder = null;
    }
    
    init() {
        // åˆå§‹åŒ–å½•åˆ¶å™¨
        this.videoRecorder = new VideoRecorder(
            this.sceneManager, 
            this.modelManager, 
            this.controlsManager
        );
        
        // åˆå§‹åŒ–æŒ‰é’®
        this.videoRecorder.initElements({
            recordButton: document.getElementById('recordButton')
        });
        
        // è®¾ç½®å¡ç‰‡åˆ›å»ºåçš„å›è°ƒ
        this.uploadManager.setOnCardCreatedCallback(() => {
            this.videoRecorder.enableRecordButton();
        });
    }
    
    getVideoRecorder() {
        return this.videoRecorder;
    }
}
```

### åœ¨ upload.js ä¸­é›†æˆ

```javascript
export class UploadManager {
    constructor(modelManager) {
        this.modelManager = modelManager;
        this.onCardCreatedCallback = null;
    }
    
    async createCard(options) {
        // åˆ›å»ºå¡ç‰‡é€»è¾‘...
        await this.modelManager.createTexturedCard(...);
        
        // è§¦å‘å›è°ƒï¼ˆå¯ç”¨å½•åˆ¶æŒ‰é’®ï¼‰
        if (this.onCardCreatedCallback) {
            this.onCardCreatedCallback();
        }
    }
    
    setOnCardCreatedCallback(callback) {
        this.onCardCreatedCallback = callback;
    }
}
```

---

## ğŸ“‹ å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: åŸºç¡€ä½¿ç”¨

```javascript
import app from './main.js';

// è·å–å½•åˆ¶å™¨
const videoRecorder = app.getVideoRecorder();

// åˆ›å»ºå¡ç‰‡ï¼ˆä¼šè‡ªåŠ¨å¯ç”¨å½•åˆ¶æŒ‰é’®ï¼‰
await app.getUploadManager().createCard({
    frontImageData: frontImageURL,
    backImageData: backImageURL
});

// æ‰‹åŠ¨å½•åˆ¶
await videoRecorder.recordVideo();
```

### ç¤ºä¾‹2: è‡ªåŠ¨åŒ–æµç¨‹

```javascript
import app from './main.js';

async function autoCreateAndRecord(frontData, backData) {
    // 1. åˆ›å»ºå¡ç‰‡
    await app.getUploadManager().createCard({
        frontImageData: frontData,
        backImageData: backData
    });
    
    // 2. ç­‰å¾…æ¸²æŸ“ç¨³å®š
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // 3. è‡ªåŠ¨å½•åˆ¶è§†é¢‘
    await app.getVideoRecorder().recordVideo({
        duration: 5000,
        fps: 60,
        bitrate: 5000000,
        rotations: 1
    });
    
    console.log('è§†é¢‘å·²ä¿å­˜');
}
```

### ç¤ºä¾‹3: æ‰¹é‡å½•åˆ¶

```javascript
import app from './main.js';

async function batchRecording(cardDataArray) {
    for (const { front, back, name } of cardDataArray) {
        // åˆ›å»ºå¡ç‰‡
        await app.getUploadManager().createCard({
            frontImageData: front,
            backImageData: back
        });
        
        // å½•åˆ¶è§†é¢‘
        await app.getVideoRecorder().recordVideo();
        
        console.log(`${name} å½•åˆ¶å®Œæˆ`);
        
        // ç­‰å¾…ä¸€ä¸‹ï¼Œé¿å…è¿‡å¿«
        await new Promise(resolve => setTimeout(resolve, 1000));
    }
}
```

### ç¤ºä¾‹4: é«˜çº§é…ç½®

```javascript
import app from './main.js';

async function recordWithPreset(preset) {
    const presets = {
        high: {
            duration: 8000,
            fps: 60,
            bitrate: 10000000,
            rotations: 1
        },
        medium: {
            duration: 5000,
            fps: 30,
            bitrate: 5000000,
            rotations: 1
        },
        low: {
            duration: 3000,
            fps: 24,
            bitrate: 2000000,
            rotations: 0.5
        }
    };
    
    await app.getVideoRecorder().recordVideo(presets[preset]);
}

// ä½¿ç”¨
await recordWithPreset('high');
```

---

## ğŸ¨ è‡ªå®šä¹‰æ ·å¼

### å½•åˆ¶æŒ‰é’®æ ·å¼

åœ¨ `styles.css` ä¸­å®šä¹‰ï¼š

```css
.record-btn {
    background: #f44336;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
}

.record-btn:hover:not(:disabled) {
    background: #d32f2f;
    transform: translateY(-2px);
}

.record-btn:disabled {
    background: rgba(244, 67, 54, 0.3);
    cursor: not-allowed;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}
```

### å½•åˆ¶ä¸­çŠ¶æ€

å½•åˆ¶æ—¶æŒ‰é’®è‡ªåŠ¨æ˜¾ç¤ºè„‰åŠ¨åŠ¨ç”»ï¼š

```javascript
// åœ¨ video-recorder.js å†…éƒ¨è‡ªåŠ¨å¤„ç†
_updateButtonState(recording) {
    if (recording) {
        this.recordButton.style.animation = 'pulse 1.5s ease-in-out infinite';
        this.recordButton.textContent = 'âºï¸ å½•åˆ¶ä¸­...';
    } else {
        this.recordButton.style.animation = 'none';
        this.recordButton.textContent = 'ğŸ¬ ç”Ÿæˆè§†é¢‘';
    }
}
```

---

## ğŸ“Š å‚æ•°è¯´æ˜

### recordVideo(options)

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `duration` | number | 5000 | å½•åˆ¶æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰ |
| `fps` | number | 60 | è§†é¢‘å¸§ç‡ |
| `bitrate` | number | 5000000 | è§†é¢‘ç ç‡ï¼ˆbpsï¼‰ |
| `rotations` | number | 1 | æ—‹è½¬åœˆæ•° |

### æ¨èé…ç½®

#### é«˜è´¨é‡ï¼ˆé€‚åˆå±•ç¤ºï¼‰
```javascript
{
    duration: 8000,
    fps: 60,
    bitrate: 10000000,
    rotations: 1
}
```

#### æ ‡å‡†è´¨é‡ï¼ˆæ¨èï¼‰
```javascript
{
    duration: 5000,
    fps: 60,
    bitrate: 5000000,
    rotations: 1
}
```

#### ä½è´¨é‡ï¼ˆå¿«é€Ÿé¢„è§ˆï¼‰
```javascript
{
    duration: 3000,
    fps: 30,
    bitrate: 2000000,
    rotations: 0.5
}
```

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### å½•åˆ¶æµç¨‹

```
1. æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
   â†“
2. è·å–Canvasè§†é¢‘æµ (captureStream)
   â†“
3. åˆ›å»ºMediaRecorder
   â†“
4. ä¿å­˜å½“å‰æ—‹è½¬çŠ¶æ€
   â†“
5. æ‰§è¡Œæ—‹è½¬åŠ¨ç”»ï¼ˆEaseInOutï¼‰
   â†“
6. æ”¶é›†è§†é¢‘æ•°æ®å—
   â†“
7. åœæ­¢å½•åˆ¶
   â†“
8. ç”ŸæˆBlobå¹¶ä¸‹è½½
   â†“
9. æ¢å¤åŸå§‹çŠ¶æ€
```

### ç¼“åŠ¨å‡½æ•°

ä½¿ç”¨ **EaseInOut** ä½¿æ—‹è½¬æ›´åŠ å¹³æ»‘ï¼š

```javascript
const easeProgress = progress < 0.5 
    ? 2 * progress * progress                    // å‰åŠæ®µï¼šåŠ é€Ÿ
    : 1 - Math.pow(-2 * progress + 2, 2) / 2;   // ååŠæ®µï¼šå‡é€Ÿ
```

### ç¼–ç æ”¯æŒ

è‡ªåŠ¨æ£€æµ‹å¹¶é€‰æ‹©æœ€ä½³ç¼–ç ï¼š

```javascript
getSupportedMimeType() {
    const types = [
        'video/webm;codecs=vp9',   // ä¼˜å…ˆ
        'video/webm;codecs=vp8',   // å¤‡é€‰
        'video/webm'               // é™çº§
    ];
    
    for (const type of types) {
        if (MediaRecorder.isTypeSupported(type)) {
            return type;
        }
    }
    
    return 'video/webm';
}
```

---

## ğŸ§ª æµ‹è¯•

### è¿è¡Œæµ‹è¯•å¥—ä»¶

æ‰“å¼€ `tests/test-video-recording.html` è¿›è¡Œæµ‹è¯•ï¼š

```
http://localhost:8000/tests/test-video-recording.html
```

### æµ‹è¯•é¡¹ç›®

1. âœ… æµè§ˆå™¨æ”¯æŒæ£€æŸ¥
2. âœ… åˆ›å»ºå¡ç‰‡å¹¶å¯ç”¨å½•åˆ¶
3. âœ… é»˜è®¤å‚æ•°å½•åˆ¶
4. âœ… è‡ªå®šä¹‰å‚æ•°å½•åˆ¶
5. âœ… ç¼–ç¨‹æ–¹å¼å½•åˆ¶

### æ‰‹åŠ¨æµ‹è¯•

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°
const recorder = app.getVideoRecorder();

// æµ‹è¯•æ”¯æŒæ€§
console.log('æ”¯æŒ:', recorder.isSupported());
console.log('MIME:', recorder.getSupportedMimeType());

// æµ‹è¯•å½•åˆ¶
await recorder.recordVideo({
    duration: 3000,
    fps: 30,
    rotations: 1
});
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### æµè§ˆå™¨å…¼å®¹æ€§

| æµè§ˆå™¨ | æ”¯æŒ | VP9 | VP8 | æ¨è |
|--------|------|-----|-----|------|
| Chrome 47+ | âœ… | âœ… | âœ… | â­â­â­â­â­ |
| Firefox 25+ | âœ… | âœ… | âœ… | â­â­â­â­â­ |
| Edge 79+ | âœ… | âœ… | âœ… | â­â­â­â­â­ |
| Safari 14.1+ | âš ï¸ | âŒ | âš ï¸ | â­â­â­ |

### æœ€ä½³å®è·µ

1. **å½•åˆ¶å‰æ£€æŸ¥å¡ç‰‡æ˜¯å¦å­˜åœ¨**
```javascript
const cube = app.getModelManager().getCube();
if (!cube) {
    alert('è¯·å…ˆåˆ›å»º3Då¡ç‰‡');
    return;
}
```

2. **é¿å…é‡å¤å½•åˆ¶**
```javascript
if (recorder.getRecordingState()) {
    console.log('æ­£åœ¨å½•åˆ¶ä¸­ï¼Œè¯·ç­‰å¾…');
    return;
}
```

3. **é”™è¯¯å¤„ç†**
```javascript
try {
    await recorder.recordVideo();
} catch (error) {
    console.error('å½•åˆ¶å¤±è´¥:', error);
    alert('å½•åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•');
}
```

4. **æ€§èƒ½ä¼˜åŒ–**
```javascript
// å½•åˆ¶å‰æš‚åœä¸å¿…è¦çš„åŠ¨ç”»
app.getControlsManager().setAutoRotate(false);

// å½•åˆ¶å®Œæˆåæ¢å¤
// ï¼ˆVideoRecorderä¼šè‡ªåŠ¨å¤„ç†ï¼‰
```

---

## ğŸš€ æ‰©å±•åŠŸèƒ½

### æ·»åŠ è¿›åº¦å›è°ƒ

å¯ä»¥æ‰©å±• `VideoRecorder` æ·»åŠ è¿›åº¦å›è°ƒï¼š

```javascript
async recordVideo(options = {}, onProgress) {
    // ...
    const animate = () => {
        const progress = Math.min(elapsed / duration, 1);
        
        // è°ƒç”¨è¿›åº¦å›è°ƒ
        if (onProgress) {
            onProgress(progress);
        }
        
        // ...
    };
}

// ä½¿ç”¨
await recorder.recordVideo({}, (progress) => {
    console.log(`å½•åˆ¶è¿›åº¦: ${(progress * 100).toFixed(0)}%`);
});
```

### æ·»åŠ æš‚åœ/æ¢å¤åŠŸèƒ½

```javascript
pauseRecording() {
    if (this.mediaRecorder && this.isRecording) {
        this.mediaRecorder.pause();
    }
}

resumeRecording() {
    if (this.mediaRecorder && this.isRecording) {
        this.mediaRecorder.resume();
    }
}
```

### æ·»åŠ å¤šè§’åº¦å½•åˆ¶

```javascript
async recordMultiAngle() {
    const angles = [
        { x: 0, y: 0 },       // æ­£é¢
        { x: 0.3, y: 0 },     // ä¿¯è§†
        { x: -0.3, y: 0 },    // ä»°è§†
        { x: 0, y: Math.PI/2 } // ä¾§é¢
    ];
    
    for (const angle of angles) {
        cube.rotation.x = angle.x;
        cube.rotation.y = angle.y;
        await this.recordVideo({ duration: 3000 });
    }
}
```

---

## ğŸ“– APIæ–‡æ¡£

å®Œæ•´çš„APIæ–‡æ¡£è¯·æŸ¥çœ‹ï¼š[API.md](./API.md#è§†é¢‘å½•åˆ¶å™¨-videorecorder)

---

## ğŸ‰ æ€»ç»“

è§†é¢‘å½•åˆ¶æ¨¡å—ç°å·²å®Œå…¨æ¨¡å—åŒ–ï¼Œæä¾›ï¼š

âœ… **ç‹¬ç«‹æ¨¡å—** - `video-recorder.js` ç‹¬ç«‹å¯å¤ç”¨  
âœ… **æ¸…æ™°API** - ç®€å•ç›´è§‚çš„æ¥å£è®¾è®¡  
âœ… **è‡ªåŠ¨é›†æˆ** - ä¸ç°æœ‰æ¨¡å—æ— ç¼é›†æˆ  
âœ… **å®Œå–„æ–‡æ¡£** - è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜å’Œç¤ºä¾‹  
âœ… **æµ‹è¯•è¦†ç›–** - å®Œæ•´çš„æµ‹è¯•å¥—ä»¶  
âœ… **é«˜å¯æ‰©å±•** - æ˜“äºæ·»åŠ æ–°åŠŸèƒ½  

ç°åœ¨ä½ å¯ä»¥é€šè¿‡ç®€å•çš„APIè°ƒç”¨å®ç°ä¸“ä¸šçš„3Då¡ç‰‡è§†é¢‘å½•åˆ¶åŠŸèƒ½ï¼ğŸ¬

---

**æœ€åæ›´æ–°**: 2025-10-27  
**ç‰ˆæœ¬**: 1.0.0

